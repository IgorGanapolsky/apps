name: EAS Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "ios | android | all"
        required: true
        default: "ios"
        type: choice
        options: [ios, android, all]
      profile:
        description: "EAS build profile"
        required: true
        default: "preview"
        type: choice
        options: [preview, production]
      project:
        description: "Project to build"
        required: true
        default: "apps-template"
        type: choice
        options: [apps-template, SuperPassword]
  push:
    tags:
      - "v*"
    paths:
      - 'apps-template/**'
      - 'SuperPassword/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: |
          cd ${{ inputs.project || 'apps-template' }}
          npm ci --no-audit --no-fund

      - name: Install EAS CLI
        run: npm i -g eas-cli

      - name: EAS whoami
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas whoami || true

      - name: Build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "EXPO_TOKEN is not set; skipping EAS Build. Add EXPO_TOKEN to repo secrets to enable builds.";
            exit 0;
          fi

          PLATFORM="${{ inputs.platform || 'ios' }}"
          PROFILE="${{ inputs.profile || 'preview' }}"
          if [ -z "$PLATFORM" ]; then PLATFORM="ios"; fi
          if [ -z "$PROFILE" ]; then PROFILE="preview"; fi

          if [ "$PLATFORM" = "all" ]; then
            eas build --platform ios --profile "$PROFILE" --non-interactive
            eas build --platform android --profile "$PROFILE" --non-interactive
          else
            eas build --platform "$PLATFORM" --profile "$PROFILE" --non-interactive
          fi

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå EAS Build failed for ${{ inputs.platform || 'ios' }} (${{ inputs.profile || 'preview' }})",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*EAS Build failed!*\n*Platform:* ${{ inputs.platform || 'ios' }}\n*Profile:* ${{ inputs.profile || 'preview' }}\n*Triggered by:* ${{ github.actor }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
